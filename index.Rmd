---
title: "Comparison of _Zostera noltii_ seagrass reflectance taken in 2018 and 2025"
author: "Lee, Chengfa Benjamin"
date: "`r Sys.Date()`"
output: bookdown::html_document2
bibliography: references.bib 
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(magrittr)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(zoo)
library(ggplot2)
library(ggiraph)
library(ggpubr)
library(patchwork)
```

This study looks at the reflectance measurements of the _Zostera noltii_ seagrass at Bourgneuf Bay in 2018 and 2025.

All analyses were performed in R version 4.5.2 [@Rversion] and belong to the [REWRITE project](https://rewriteproject.eu/). The 2018 data was collected under [CoastObs](https://coastobs.eu/success-story/french-atlantic-coast) and the 2025 data under REWRITE.

# Data

ASD measurements, seagrass percent cover estimation and sample collection were done on the seagrasses at Bourgneuf Bay in 2018 and 2025. The hyperspectral data for each station were averaged and smoothed. NDVI was calculated based on the 670 nm and 800 nm wavelengths. Meanwhile, the collected samples were then sorted, dried and weighed in the laboratory to obtain the leaf dry weight. For a more detailed description of the methods, please refer to @zoffoli2020 and [the 2025 fieldwork GitPage]((https://sigoiry.github.io/Fieldtrip_Rewrite_Sept2025/)).  

```{r preprocessing2018}
#| echo: false
#| error: false
#| message: false
#| warning: false

srf <- read_xlsx('data/COPE-GSEG-EOPG-TN-15-0007 - Sentinel-2 Spectral Response Functions 2022 - 3.2.xlsx', sheet = 'Spectral Responses (S2A)') %>% 
  filter(SR_WL >= 400, SR_WL <= 900)

csv.2018 <- local({
  biomass <- read.csv('data/2018/2018_09_Bourgneuf_cores_biomass_percent_cover.csv', sep = '\t')
    biomass$Leaf_dry_weight_g <- biomass$Leaf_dry_weight_g * 100^2 / (pi*7.5^2)
  reflectance <- read.table('data/2018/2018_09_Bourgneuf_reflectance-cores_raw.txt', header = TRUE) %>%
    pivot_longer(cols = names(.)[-1], names_to = "Sample_ID", values_to = 'raw.value') %>%
    filter(wavelength >= 400, wavelength <= 900)
  
    reflectance$Sample_ID <- reflectance$Sample_ID %>%
      lapply(FUN = function(string) {
        string %>%
          strsplit(split = "\\.") %>% 
          unlist() %>%
          "["(1) %>%
          strsplit(split = "_") %>% 
          unlist() %>%
          "["(-length(.)) %>%
          paste(collapse = "_")
      }) %>%
      unlist()
  
 output <- reflectance %>%
    group_by(Sample_ID) %>%
    mutate(norm.value = (raw.value - min(raw.value))/(max(raw.value) - min(raw.value)), red = weighted.mean(raw.value, srf$S2A_SR_AV_B4), nir = weighted.mean(raw.value, srf$S2A_SR_AV_B8), ndvi = (nir - red)/(nir + red), .keep = "all") %>%
    ungroup %>%
    full_join(biomass, by = NULL) %>%
    pivot_longer(cols = c(raw.value, norm.value), names_to = 'processing', values_to = 'value') %>%
    rename(Wavelength = wavelength, Station = Sample_ID, Leaf_DW = Leaf_dry_weight_g) %>%
    select(-c(red, nir))
 
  output$processing <- factor(output$processing, levels = c('raw.value', 'norm.value'), labels = c('Raw reflectance', 'Min-max normalised reflectance'))
  output$year <- 2018
  output$Root_DW <- NA
  
 output
})
```

```{r preprocessing2019}
#| echo: false
#| error: false
#| message: false
#| warning: false

csv.2019 <- local({
  output <- read_xlsx('data/2019/Data AGB BGB Bourgneuf 2019.xlsx') %>% 
    rename(c(Station = Sample_ID, ndvi = NDVI, Leaf_DW = `Leaf biomass (g DW m-2)`, Root_DW = `Rizhome biomass  (g DW m-2)`, Percent_cover = `Seagrass coverage (%)`))
  
  output$Wavelength <- NA
  output$processing <- 'Raw reflectance'
  output$value <- NA
  output$year <- 2019
  
 output
})
```

```{r preprocessing2025}
#| echo: false
#| error: false
#| message: false
#| warning: false

csv.2025 <- local({
  biomass <- read_xlsx('data/2025/DryWeight_Cores.xlsx')
    biomass$A <- biomass$A * 100^2 / (pi*7.5^2)
    biomass$B <- biomass$B * 100^2 / (pi*7.5^2)
  reflectance <- read.csv('data/2025/20250911_Bourgneuf_H_stations_reflectance.txt', sep = '\t') %>%
    pivot_longer(cols = names(.) %>% grep('Wavelength', ., invert = TRUE, value = TRUE), names_to = "ASD", values_to = 'value')
    
    reflectance$Station <- lapply(reflectance$ASD, FUN = function(string) {
      str_split(string, '\\.') %>%
        unlist() %>%
        "["(1)
      }) %>% 
      unlist()
  
  output <- reflectance %>%
    group_by(Wavelength,Station) %>%
    summarise(raw.value = mean(value, na.rm = TRUE)) %>%
    ungroup() %>%
    group_by(Station) %>%
    mutate(raw.value = rollapply(raw.value, 11, mean, partial = TRUE, align = 'center'), .keep = 'all') %>% 
    ungroup() %>%
    filter(Wavelength >= 400, Wavelength <= 900) %>%
    group_by(Station) %>%
    mutate(norm.value = (raw.value - min(raw.value))/(max(raw.value) - min(raw.value)), red = weighted.mean(raw.value, srf$S2A_SR_AV_B4), nir = weighted.mean(raw.value, srf$S2A_SR_AV_B8), ndvi = (nir - red)/(nir + red), .keep = "all") %>%
    ungroup() %>%
    select(-c(red, nir))
  
  output$Station <- output$Station %>%
    gsub('H', "H_", .)  
  
  output <- output %>% 
    full_join(biomass) %>%
    pivot_longer(cols = c(raw.value, norm.value), names_to = 'processing', values_to = 'value')
    output$processing <- factor(output$processing, levels = c('raw.value', 'norm.value'), labels = c('Raw reflectance', 'Min-max normalised reflectance'))
  
  output$year <- 2025
  output$Percent_cover <- NA
  
  output %>%
    rename(Leaf_DW = A, Root_DW = B)
})
```

```{r combine.datasets}
#| echo: false
#| error: false
#| message: false
#| warning: false

csv <- rbind(csv.2018, csv.2019, csv.2025)
```


# Comparison

```{r compareLeafRoot}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| fig.cap: Comparison of leaf biomass to root biomass across all three epochs.

plt.spc_dw <- csv %>%
  select(Station, Leaf_DW, Root_DW, year) %>%
  unique() %>%
  filter(Leaf_DW != 0) %>%
  ggplot(aes(x = Leaf_DW, y = Root_DW)) +
    geom_smooth(method = 'lm') +
    geom_point_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station)) +
    xlab(bquote('Leaf dry weight ('~g/m^2~')')) + ylab(bquote('Root dry weight ('~g/m^2~')')) +
    xlim(c(0, max(csv.2025$Leaf_DW, na.rm = TRUE))) + ylim(c(0, max(csv.2025$Root_DW, na.rm = TRUE))) +
    stat_regline_equation(label.x.npc = 'left', label.y.npc = 'top', decreasing = TRUE, aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), colour = 'blue') +
    facet_grid(. ~ year)

girafe(ggobj = plt.spc_dw,
         options = list(
           opts_hover(css = "stroke-width:1px"),
           opts_hover_inv(css = "opacity:0.25"),
           opts_tooltip(opacity = 0.95, css = "padding:4px; font-size:18px")
         ),
         height_svg = 5, width_svg = 12
  )
```

```{r compileLeafRoot}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| fig.cap: Comparison of leaf biomass to root biomass, compiled across all three epochs.

plt.spc_dw <- csv %>%
  select(Station, Leaf_DW, Root_DW, year) %>%
  unique() %>%
  filter(Leaf_DW != 0) %>%
  ggplot(aes(x = Leaf_DW, y = Root_DW)) +
    geom_smooth(method = 'lm') +
    geom_point_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station)) +
    xlab(bquote('Leaf dry weight ('~g/m^2~')')) + ylab(bquote('Root dry weight ('~g/m^2~')')) +
    xlim(c(0, max(csv.2025$Leaf_DW, na.rm = TRUE))) + ylim(c(0, max(csv.2025$Root_DW, na.rm = TRUE))) +
    stat_regline_equation(label.x.npc = 'left', label.y.npc = 'top', decreasing = TRUE, aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), colour = 'blue')

girafe(ggobj = plt.spc_dw,
         options = list(
           opts_hover(css = "stroke-width:1px"),
           opts_hover_inv(css = "opacity:0.25"),
           opts_tooltip(opacity = 0.95, css = "padding:4px; font-size:18px")
         ),
         height_svg = 5, width_svg = 12
  )
```

For the 2018 dataset, there is a linear relationship between the logarithmic-transformed leaf dry weight and the leaf percent cover (Figure \@ref(fig:compareSpcDw)). This suggests that there is a saturation of leaf percent cover at larger leaf dry weight/biomass. For example, the stations with a 100% seagrass cover had dry weights ranging from 3.72 g (zos_d_61) up to 5.23 g (zos_a_61).


```{r compareSpcDw}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| fig.cap: Comparison of leaf percent cover against its logarithmic-transformed leaf dry weight. For now, only the 2018 dataset has leaf percent cover data. For the purpose of clarity, stations with no (zero) leaf dry weight were removed from the analysis as their log-transformed value would be negative infinity. Regardless, their presence/absence did not affect the regression equation or R-squared value.

plt.spc_dw <- csv %>%
  select(Station, Percent_cover, Leaf_DW, year) %>%
  unique() %>%
  filter(Leaf_DW != 0) %>%
  ggplot(aes(x = Percent_cover, y = log(Leaf_DW))) +
    geom_smooth(method = 'lm') +
    geom_point_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station)) +
    xlab('Seagrass cover (%)') + ylab(bquote('Logarithmic-transformed leaf dry weight ('~g/m^2~')')) +
    stat_regline_equation(label.x.npc = 'left', label.y.npc = 'top', decreasing = TRUE, aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), colour = 'blue') +
    facet_grid(. ~ year)

girafe(ggobj = plt.spc_dw,
         options = list(
           opts_hover(css = "stroke-width:1px"),
           opts_hover_inv(css = "opacity:0.25"),
           opts_tooltip(opacity = 0.95, css = "padding:4px; font-size:18px")
         ),
         height_svg = 5, width_svg = 12
  )
```


The logarithmic-transformed NDVI model had a better R-squared value for the 2018 dataset but a worse R-squared value for the 2025 dataset. The logarithmic-transformed dry weight model performed worse. Thus, the linear model was kept.  

Between 2018 and 2025, it is apparent that the 2018 dataset have a higher leaf dry weight and larger spectroradiometer-derived NDVI values than the 2025 dataset (Figure \@ref(fig:compareNdviDw)). Also, the gradient of the relationship is different between the two years. This would suggest that caution should be exercised when transferring reflectance-to-biomass relationship across time.


```{r compareNdviDw}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| fig.cap: Comparison of spectroradiometer-derived NDVI against leaf dry weight across the three epochs.

## Linear model
plt.ndvi_dw.lm <- csv %>%
  select(Station, Percent_cover, Leaf_DW, year, processing, ndvi) %>%
  unique() %>%
  ggplot(aes(x = Leaf_DW, y = ndvi)) +
    geom_smooth(method = 'lm') +
    geom_point_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station)) +
    ylab('Spectroradiometer-derived NDVI') + xlab(bquote('Leaf dry weight ('~g/m^2~')')) +
    ylim(c(0,1)) + xlim(c(0,300)) +
    stat_regline_equation(label.x.npc = 'left', label.y.npc = 'top', decreasing = TRUE, aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), colour = 'blue') +
    facet_grid(. ~ year,  scales = 'free')

girafe(ggobj = plt.ndvi_dw.lm,
         options = list(
           opts_hover(css = "stroke-width:1px"),
           opts_hover_inv(css = "opacity:0.25"),
           opts_tooltip(opacity = 0.95, css = "padding:4px; font-size:18px")
         ),
         height_svg = 5, width_svg = 14
  )
```

```{r compileNdviDwNLS}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| fig.cap: Comparison of spectroradiometer-derived NDVI against leaf dry weight, compiled.

## Linear model
plt.ndvi_dw.lm <- csv %>%
  select(Station, Percent_cover, Leaf_DW, year, processing, ndvi) %>%
  unique() %>%
  ggplot(aes(x = Leaf_DW, y = ndvi)) +
    geom_smooth(method = 'lm', colour = 'black') +
    geom_point_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station, colour = factor(year))) +
    scale_colour_viridis_d('Year', option = 'turbo') +
    ylab('Spectroradiometer-derived NDVI') + xlab(bquote('Leaf dry weight ('~g/m^2~')')) +
    ylim(c(0,1)) +
    stat_regline_equation(label.x.npc = 'left', label.y.npc = 'top', decreasing = TRUE, aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), colour = 'black')

## Log model
csv.log <- csv %>%
  select(Station, Percent_cover, Leaf_DW, year, ndvi) %>%
  unique() %>%
  filter(!is.na(ndvi), !is.na(Leaf_DW))

init.c <- max(csv.log$ndvi, na.rm = TRUE) 
model.lm <- lm(init.c - ndvi ~ Leaf_DW, data = csv.log)
model.nls <- nls(ndvi ~ a * (1 - exp(b*Leaf_DW)), data = csv.log, start = list(a = model.lm$coefficients[1], b = model.lm$coefficients[2]))
model.nls.equation <- substitute(italic(y) == a * (1 - e^(b*x) ) * "," * ~italic("Residual SE") ~ "=" ~ rse, 
                                 list(x = "x", y = "y",
                                      a = summary(model.nls)$coefficients[1, 'Estimate'] %>% unname() %>% round(2) %>% format(nsmall = 2),
                                      b = summary(model.nls)$coefficients[2, 'Estimate'] %>% unname() %>% round(2) %>% format(nsmall = 2),
                                      rse =  summary(model.nls)$sigma %>% round(2) %>% format(nsmall = 2)
                                      )) %>% 
  as.expression() %>%
  as.character()

plt.ndvi_dw.nls <- ggplot(csv.log, aes(x = Leaf_DW, y = ndvi, colour = factor(year))) +
  geom_line(data = data.frame(x = csv.log$Leaf_DW, y = predict(model.nls, newdata = csv.log)), aes(x = x, y = y), colour = 'black') +
  geom_point_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station)) +
  scale_colour_viridis_d('Year', option = 'turbo') +
  ylab('Spectroradiometer-derived NDVI') + xlab(bquote('Leaf dry weight ('~g/m^2~')')) +
  ylim(c(0,1)) +
  annotate("text", x = 1, y = Inf, hjust = 0, vjust = 2, label = model.nls.equation, parse = TRUE, colour = 'black')

girafe(ggobj = plt.ndvi_dw.lm + plt.ndvi_dw.nls + plot_layout(axis_titles = 'collect', guides = 'collect'),
         options = list(
           opts_hover(css = "stroke-width:1px"),
           opts_hover_inv(css = "opacity:0.25"),
           opts_tooltip(opacity = 0.95, css = "padding:4px; font-size:18px")
         ),
         height_svg = 5, width_svg = 12
  )
```


The 2018 dataset demonstrate that the normalised reflectance would substantially decrease with an increase in seagrass cover, up to about 70% seagrass cover (Figure \@ref(fig:compareHsSpc)). Beyond 70% seagrass cover, the decrease in the normalised reflectance spectra is small and not as consistent. For example, between 700 nm and 900 nm, while stations with a 100% seagrass cover such as zos_d_61 and zos_e_61 had a lower spectra in this range than seagrass covers with less than 100%, there were also other stations with a 100% seagrass cover such as zos_a_61 and zos_c_61 that instead had a higher spectra.  


```{r compareHsSpc}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| fig.cap: Comparison of reflectance spectra against the leaf percent cover. For now, only the 2018 dataset has leaf percent cover data, so the 2025 dataset is greyed out.

plt.spectra_spc <- ggplot(csv, aes(x = Wavelength, y = value, group = Station, colour = Percent_cover)) +
  geom_line_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station)) +
  xlab('Wavelength (nm)') + ylab('Reflectance') +
  scale_colour_viridis_c('Seagrass cover (%)', option = 'turbo') + 
  facet_grid(processing ~ year,  scales = 'free')

girafe(ggobj = plt.spectra_spc,
         options = list(
           opts_hover(css = "stroke-width:1px"),
           opts_hover_inv(css = "opacity:0.25"),
           opts_tooltip(opacity = 0.95, css = "padding:4px; font-size:18px")
         ),
         height_svg = 5, width_svg = 12
  )
```


When the reflectance spectra was compared against the leaf dry weight, there is also a pattern of a lower reflectance spectra with increasing dry weight, in particular the normalised spectra (Figure \@ref(fig:compareHsDw)). However, the proportion or numbers were not similar between the two epochs. For example, the normalised reflectance for a station with a dry weight of around 5 g in 2018 has a similar spectra with one in 2025 with a dry weight of around 1.4 g (H_13). A station with a dry weight of about 1.5 g in 2018 (zos_21) would instead have a similar normalised reflectance to a station in 2025 with a dry weight of about 1 g (H_29). Particularly, there seems to be a consistently/relatively lower normalised reflectance at 670 nm with increasing dry weight. 

It is more difficult to comment the same about the raw reflectance, as the raw reflectances in 2025 seem to have either more overlaps or possibly differences in ambient light.


```{r compareHsDw}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| fig.cap: Comparison of reflectance spectra against the leaf dry weight.

plt.spectra_dw <- ggplot(csv, aes(x = Wavelength, y = value, group = Station, colour = Leaf_DW)) +
  geom_line_interactive(aes(tooltip = paste0("Station: ", Station), data_id = Station)) +
  xlab('Wavelength (nm)') + ylab('Reflectance') +
  scale_colour_viridis_c('Leaf dry weight (g)', option = 'turbo') + 
  facet_grid(processing ~ year,  scales = 'free')

girafe(ggobj = plt.spectra_dw,
         options = list(
           opts_hover(css = "stroke-width:1px"),
           opts_hover_inv(css = "opacity:0.25"),
           opts_tooltip(opacity = 0.95, css = "padding:4px; font-size:18px")
         ),
         height_svg = 5, width_svg = 12
  )
```



# References